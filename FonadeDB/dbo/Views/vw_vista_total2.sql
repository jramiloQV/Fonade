CREATE VIEW [dbo].[vw_vista_total2] AS
SELECT DISTINCT 
p.Id_Proyecto, 
em.Nit Empresa,
ci.Id_Ciudad Ciudad, 
ci.nomciudad,
d.Id_Departamento,
sec.Id_Sector,
sec.NomSector Sector,
d.NomDepartamento,
eg.total empleos,
eo.ValorRecomendado * sm.SalarioMinimo as recursos
FROM 
dbo.Proyecto p,
dbo.Estado e,
dbo.ConvocatoriaProyecto cp,
dbo.Convocatoria c,
dbo.Empresa em,
dbo.Ciudad ci,
dbo.Departamento d,
dbo.subsector ss,
dbo.Evaluacionobservacion eo,
dbo.sector sec,
dbo.proyectoaporte pa,
dbo.proyectogastospersonal pgp,
dbo.EmpleosGenerados eg,
dbo.SalariosMinimos sm,
(	select p.id_proyecto proyecto, max(cp.Fecha) fecha
	FROM dbo.ConvocatoriaProyecto cp, dbo.proyecto p
	WHERE cp.CodProyecto = p.Id_Proyecto		
	group by p.id_proyecto
	UNION
	select p.id_proyecto proyecto, cp.Fecha fecha
	FROM dbo.ConvocatoriaProyecto cp, dbo.proyecto p
	WHERE cp.CodProyecto = p.Id_Proyecto		
	AND p.id_proyecto in (48340,1212,35327,38676,7342)	
	) as f
WHERE 
p.CodEstado = e.Id_Estado
AND sm.AñoSalario = (select (DatePart(yyyy,c.FechaInicio)))
AND p.Id_Proyecto = cp.CodProyecto
AND p.Id_Proyecto = eo.CodProyecto
AND p.Id_Proyecto = eg.CodProyecto
AND p.CodSubSector = ss.Id_SubSector
AND sec.Id_Sector = ss.CodSector
AND cp.CodConvocatoria = c.Id_Convocatoria
AND f.proyecto = p.Id_Proyecto
AND f.fecha = cp.fecha
AND cp.Viable = 1
AND em.codproyecto = p.Id_Proyecto
AND p.CodCiudad = ci.Id_Ciudad
AND ci.CodDepartamento = d.Id_Departamento
AND p.codEstado not in (11,10) 
AND p.Id_Proyecto = pgp.CodProyecto
AND c.Id_Convocatoria = eo.CodConvocatoria
AND p.Id_Proyecto NOT IN (
10812,11749,13875,14620,15717,15904,16282,16568,16720,16805,17550,18135,19565,20516,20581
,20771,20803,21210,21284,22168,22248,22295,22420,22422,23306,23363,23465,23466,23582,23710
,23919,23923,24102,24581,24646,24753,24978,25146,25240,25241,25546,25560,25711,25773,26261,26333
,26638,26640,26740,26744,27121,27171,27204,27239,27357,27396,27399,27427,27430,27464,27507
,27643,27648,27656,27664,27684,27685,27753,27759,27801,27807,27853,28085,28092,28116,28119
,28159,28201,28209,28240,28370,28417,28432,28474,28501,28513,28515,28522,28557,28572,28746
,28867,28892,29130,29168,29195,29230,29247,29248,29417,29455,29476,29477,29579,29583,29587
,29711,29864,29882,29926,29934,29956,30006,30046,30211,30221,30300,30317,30354,30976,33134
,33275,33331,33332,33512,33531,33589,33976,34111,34152,34425,34764,35064,35489,35579,35793
,35920,36066,36150,51458)
UNION
SELECT distinct 
p.Id_Proyecto, 
NULL Empresa,
ci.Id_Ciudad Ciudad, 
ci.nomciudad,
d.Id_Departamento,
sec.Id_Sector,
sec.NomSector Sector,
d.NomDepartamento,
NULL Empleos,
max(eo.ValorRecomendado * sm.SalarioMinimo) as recursos
FROM
Estado e, Proyecto p,
ConvocatoriaProyecto cp,
dbo.Evaluacionobservacion eo,
dbo.EmpleosGenerados eg,
dbo.subsector ss,
dbo.Convocatoria c,
dbo.sector sec,
(	select distinct p.id_proyecto proyecto, max(cp.Fecha) fecha
	FROM dbo.ConvocatoriaProyecto cp, dbo.proyecto p
	WHERE cp.CodProyecto = p.Id_Proyecto	
	group by p.id_proyecto) as f,
dbo.Empresa em,
dbo.Ciudad ci,
dbo.Departamento d,
dbo.proyectogastospersonal pgp,
dbo.SalariosMinimos sm
WHERE p.CodEstado = e.Id_Estado
AND cp.CodProyecto = p.Id_Proyecto
AND eo.CodProyecto = p.Id_Proyecto
AND eg.CodProyecto = p.Id_Proyecto
AND p.CodSubSector = ss.Id_SubSector
AND sec.Id_Sector = ss.CodSector
AND f.proyecto = p.Id_Proyecto
AND f.fecha = cp.fecha
AND sm.AñoSalario = (select (DatePart(yyyy,c.fechaInicio)))
AND p.CodCiudad = ci.Id_Ciudad
AND ci.CodDepartamento = d.Id_Departamento
AND c.Id_Convocatoria = eo.CodConvocatoria
AND p.Id_Proyecto IN (17,1212,197,716,755,1725,1805,1875,2441,2795,2959,5949,8413,9176,9495,9850
,11040,11973,12006,13851,13993,16516,16843,17152,17775,17776,17781,17886,17892,19571,19600,20914
,20970,21277,22125,23197,23834,24015,24064,24375,24841,26417,26427,28275,29687,31102,33495,35679
,36098,37356,38202,41323,42663,43634,45577,45816,45917,46063,46137,46355,47042,47302,47394,47762
,47781,47813,48015,48035,48315,48328,48335,48716,48725,49203,49315,49945,50309,50620,50714,51537
,52001,52070,52247,52284,52677,52693,52717,52821,52886,53200,53419,53541,53553
,53586,53610,54203,54591,54761,54929,
36459,44367,46674,47440,48154,48929,49061,49124,49200,49203,49235,50033,50301
,50488,50498,50958,51037,51217,51441,51484,51672,51808,51817,51841,51873,51934,51987,51988,52067,52088
,52089,52116,52160,52301,52340,52344,52351,52364,52382,52470,52501,52528,52562,52584,52646,52659,52806
,52810,52846,52937,52943,52971,53044,53045,53062,53084,53155,53191,53196,53209,53225,53226,53269,53274
,53278,53297,53308,53313,53325,53342,53433,53484,53632,53691,53708,53712,53721,53734,53741,53747,53754
,53824,53849,53880,53908,53926,53927,53929,53996,53999,54004,54015,54016,54022,54023,54024,54141,54146
,54198,54211,54212,54237,54258,54268,54273,54317,54413,54433,54434,54465,54496,54577,54588,54617,54649
,54659,54660,54674,54679,54700,54720,54765,54769,54792,54818,54840,54853,54870,54879,54901,54905,54921
,54937,54945,54952,54955,54962,55967,55978,55984,56003,56011,56014,56015,56022,56027,56035,56047,56052
,56056,56057,56068,56135,56143,56146,56152,56158,56163,56190,56198,56204,56223,56248,56259,56264,56266
,56270,56291,56292,56297,56304,56323,56332,56348,56354,56364,56378,56393,56403,56410,56432,56441,56451
,56456,56459,56468,56470,56479,56482,56487,56495,56496,56504,56520,56525,56532,56535,56541,56551,56565
,56566,56567,56568,56572,56576,56579,56585,56591,56610,56627,56630,56640,56648,56659,56663,56668,56682
,56714,56739,56742,56746,56755,56756,56757,56768,56770,56784,56790,56795,56800,56807,56847,56858,56859
,56867,56902,56908,56909,56911,56915,56935,56940,56941,56953,56967,56968,56970,56977,56980,56997,57004
,57017,57018,57022,57024,57041,57044,57047,57051,57057,57058,57069,57081,57083,57085,57090,57103,57105
,57107,57126,57134,57135,57136,57137,57138,57139,57140,57159,57176,57196,57203,57204,57209,57210,57217
,57218,57223,57224,57243,57246,57263,57265,57268,57274,57278,57280,57287,57291,57295,57302,57305,57307
,57309,57312,57316,57344,57349,57355,57361,57365,57376,57382,57386,57391,57399,57406,57407,57409,57417
,57429,57436,57440,57444,57447,57450,57459,57467,57473,57475,57481,57493,57494,57496,57497,57499,57503
,57504,57507,57508,57509,57510,57518,57521,57523,57535,57538,57547,57549,57550,57555,57577,57579)
GROUP BY
p.Id_Proyecto, 
ci.Id_Ciudad, 
ci.nomciudad,
d.Id_Departamento,
sec.Id_Sector,
sec.NomSector,
d.NomDepartamento